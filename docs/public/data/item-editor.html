<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©å“è¡¨ç¼–è¾‘å™¨ - é€ƒç¦»é¸­ç§‘å¤«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .toolbar {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 1px solid #dee2e6;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
        }

        .items-list {
            padding: 20px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .items-grid {
            display: grid;
            gap: 15px;
        }

        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .item-card-image-wrapper {
            text-align: center;
            margin-bottom: 10px;
        }

        .item-card-image {
            max-width: 64px;
            max-height: 64px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .item-card-icon {
            font-size: 48px;
            display: inline-block;
        }

        .item-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .item-card.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-id {
            font-size: 12px;
            color: #666;
            background: #f1f3f5;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        .item-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .tag {
            font-size: 12px;
            padding: 3px 8px;
            background: #e9ecef;
            border-radius: 4px;
            color: #495057;
        }

        .editor-panel {
            background: #f8f9fa;
            padding: 20px;
            border-left: 1px solid #dee2e6;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .editor-panel h3 {
            margin-bottom: 15px;
            color: #212529;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .quality-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .quality-1 { background: #999999; color: white; }
        .quality-2 { background: #1EFF00; color: white; }
        .quality-3 { background: #0070DD; color: white; }
        .quality-4 { background: #A335EE; color: white; }
        .quality-5 { background: #FFD700; color: #333; }
        .quality-6 { background: #FF8000; color: white; }
        .quality-7 { background: #FF0000; color: white; }
        .quality-8 { background: #8B00FF; color: white; }
        .quality-9 { background: #FF1493; color: white; }

        .tags-input {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tags-display {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            min-height: 32px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .tag-display-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        }

        .tag-display-item .remove-display-tag {
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
            margin-left: 3px;
        }

        .tag-input {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        .tag-input input {
            border: none;
            padding: 0;
            margin: 0;
        }

        .tag-input .remove-tag {
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
        }

        .add-tag-input {
            display: inline-flex;
            gap: 5px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: 600;
            color: #212529;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }

            .editor-panel {
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ ç‰©å“è¡¨ç¼–è¾‘å™¨</h1>
            <p>è½»æ¾ç®¡ç†ã€Šé€ƒç¦»é¸­ç§‘å¤«ã€‹ç‰©å“æ•°æ®</p>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="addItem()">â• æ·»åŠ ç‰©å“</button>
            <button class="btn btn-secondary" onclick="exportJSON()">ğŸ“¥ å¯¼å‡º JSON</button>
            <button class="btn btn-secondary" onclick="importJSON()">ğŸ“¤ å¯¼å…¥ JSON</button>
            <button class="btn btn-secondary" onclick="importTXT()">ğŸ“„ å¯¼å…¥ TXT</button>
            <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
            <div class="stat" style="margin-left: auto;">
                <span class="stat-label">ç‰©å“æ•°é‡ï¼š</span>
                <span class="stat-value" id="itemCount">0</span>
            </div>
        </div>

        <div class="content">
            <div class="items-list">
                <div class="items-grid" id="itemsGrid"></div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <svg viewBox="0 0 64 64" fill="currentColor">
                        <path d="M32 8 C20 8 10 18 10 30 C10 42 20 52 32 52 C44 52 54 42 54 30 C54 18 44 8 32 8 Z M32 48 C22 48 14 40 14 30 C14 20 22 12 32 12 C42 12 50 20 50 30 C50 40 42 48 32 48 Z"/>
                        <path d="M32 22 L32 38 M24 30 L40 30"/>
                    </svg>
                    <h3>æš‚æ— ç‰©å“</h3>
                    <p>ç‚¹å‡»ã€Œæ·»åŠ ç‰©å“ã€å¼€å§‹åˆ›å»º</p>
                </div>
            </div>

            <div class="editor-panel">
                <h3>ğŸ“ ç¼–è¾‘ç‰©å“</h3>
                <div id="editorForm">
                    <div class="form-group">
                        <label>ç‰©å“ID *</label>
                        <input type="text" id="itemId" placeholder="ä¾‹å¦‚: 1">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¸­æ–‡å *</label>
                            <input type="text" id="nameCN" placeholder="ä¾‹å¦‚: æ­¢è¡€ç»·å¸¦">
                        </div>
                        <div class="form-group">
                            <label>è‹±æ–‡å *</label>
                            <input type="text" id="nameEN" placeholder="ä¾‹å¦‚: Bandage">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>å“è´¨ *</label>
                            <select id="quality">
                                <option value="1">1 - å¸¸è§(lv.1) (ç°)</option>
                                <option value="2">2 - ç½•è§(lv.2) (ç»¿)</option>
                                <option value="3">3 - ç¨€æœ‰(lv.3) (è“)</option>
                                <option value="4">4 - å²è¯—(lv.4) (ç´«)</option>
                                <option value="5">5 - ä¼ è¯´(lv.5) (é‡‘)</option>
                                <option value="6">6 - ç¥è¯(lv.6) (æ©™)</option>
                                <option value="7">7 - è‡³å°Š(lv.7) (çº¢)</option>
                                <option value="8">8 - è¿œå¤(lv.8) (æ·±ç´«)</option>
                                <option value="9">9 - æ°¸æ’(lv.9) (ç²‰)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä»·æ ¼</label>
                            <input type="number" id="price" placeholder="ä¾‹å¦‚: 80">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>é‡é‡ (kg)</label>
                            <input type="number" id="weight" step="0.01" placeholder="ä¾‹å¦‚: 0.05">
                        </div>
                        <div class="form-group">
                            <label>å›¾æ ‡</label>
                            <input type="text" id="image" placeholder="ä¾‹å¦‚: ğŸ’Š">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ ‡ç­¾</label>
                        <div id="tagsDisplay" class="tags-display"></div>
                        <div class="add-tag-input">
                            <input type="text" id="newTag" placeholder="è¾“å…¥æ ‡ç­¾åå›è½¦æˆ–ç‚¹å‡»æ·»åŠ " 
                                   onkeypress="if(event.key==='Enter') addTag()">
                            <button class="btn btn-primary" onclick="addTag()">æ·»åŠ </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>è´­ä¹°æº</label>
                        <div id="marketDisplay" class="tags-display"></div>
                        <div class="add-tag-input">
                            <input type="text" id="newMarket" placeholder="ä¾‹å¦‚: å•†åº—ï¼Œæ— è´­ä¹°æ¥æºåˆ™ç©º" 
                                   onkeypress="if(event.key==='Enter') addMarket()">
                            <button class="btn btn-primary" onclick="addMarket()">æ·»åŠ </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æè¿°</label>
                        <textarea id="description" placeholder="ç‰©å“æè¿°..."></textarea>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveItem()" style="width: 100%;">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelEdit()" style="width: 100%; margin-top: 10px;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        let editingIndex = -1;

        // å“è´¨æ˜ å°„
        const qualityMap = {
            1: { name: 'å¸¸è§(lv.1)', color: '#999999' },
            2: { name: 'ç½•è§(lv.2)', color: '#1EFF00' },
            3: { name: 'ç¨€æœ‰(lv.3)', color: '#0070DD' },
            4: { name: 'å²è¯—(lv.4)', color: '#A335EE' },
            5: { name: 'ä¼ è¯´(lv.5)', color: '#FFD700' },
            6: { name: 'ç¥è¯(lv.6)', color: '#FF8000' },
            7: { name: 'è‡³å°Š(lv.7)', color: '#FF0000' },
            8: { name: 'è¿œå¤(lv.8)', color: '#8B00FF' },
            9: { name: 'æ°¸æ’(lv.9)', color: '#FF1493' }
        };

        // è·å–å“è´¨åç§°
        function getQualityName(quality) {
            return qualityMap[quality]?.name || `å“è´¨ ${quality}`;
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡URL
        function isImageUrl(str) {
            if (!str || typeof str !== 'string') return false;
            return str.startsWith('http://') || str.startsWith('https://') || str.startsWith('//');
        }

        // è·å–å›¾ç‰‡HTML
        function getImageHtml(item) {
            if (!item.image) return '';
            if (isImageUrl(item.image)) {
                return `<img src="${item.image}" alt="${item.nameCN}" class="item-card-image" onerror="this.style.display='none';">`;
            }
            return `<span class="item-card-icon">${item.image}</span>`;
        }

        // åŠ è½½æœ¬åœ°å­˜å‚¨
        function loadItems() {
            const saved = localStorage.getItem('items_data');
            if (saved) {
                items = JSON.parse(saved);
            }
            renderItems();
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveItems() {
            localStorage.setItem('items_data', JSON.stringify(items));
            renderItems();
        }

        // æ¸²æŸ“ç‰©å“åˆ—è¡¨
        function renderItems() {
            const grid = document.getElementById('itemsGrid');
            const emptyState = document.getElementById('emptyState');
            const itemCount = document.getElementById('itemCount');
            
            itemCount.textContent = items.length;

            if (items.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = items.map((item, index) => `
                <div class="item-card ${editingIndex === index ? 'active' : ''}" 
                     onclick="editItem(${index})">
                    ${getImageHtml(item) ? `<div class="item-card-image-wrapper">${getImageHtml(item)}</div>` : ''}
                    <div class="item-header">
                        <div>
                            <span class="item-id">#${item.id}</span>
                            <span class="item-name">${item.nameCN}</span>
                        </div>
                        <span class="quality-badge quality-${item.quality || 1}">
                            ${getQualityName(item.quality || 1)}
                        </span>
                    </div>
                    <div style="color: #666; font-size: 14px; margin-bottom: 8px;">${item.nameEN}</div>
                    <div class="item-tags">
                        ${(item.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                        ${(item.market || []).map(source => `<span class="tag" style="background: #d4edda; color: #155724;">${source}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // æ·»åŠ ç‰©å“
        function addItem() {
            editingIndex = -1;
            clearForm();
            document.getElementById('editorForm').scrollIntoView({ behavior: 'smooth' });
        }

        // ç¼–è¾‘ç‰©å“
        function editItem(index) {
            editingIndex = index;
            const item = items[index];
            
            document.getElementById('itemId').value = item.id;
            document.getElementById('nameCN').value = item.nameCN || '';
            document.getElementById('nameEN').value = item.nameEN || '';
            document.getElementById('quality').value = item.quality || 1;
            document.getElementById('price').value = item.price || '';
            document.getElementById('weight').value = item.weight || '';
            document.getElementById('image').value = item.image || '';
            document.getElementById('description').value = item.description || '';
            
            // æ¸²æŸ“æ ‡ç­¾
            renderTags(item.tags || []);
            renderMarket(item.market || []);
            
            document.getElementById('editorForm').scrollIntoView({ behavior: 'smooth' });
        }

        // æ¸…é™¤è¡¨å•
        function clearForm() {
            document.getElementById('itemId').value = '';
            document.getElementById('nameCN').value = '';
            document.getElementById('nameEN').value = '';
            document.getElementById('quality').value = '1';
            document.getElementById('price').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('image').value = '';
            document.getElementById('description').value = '';
            renderTags([]);
            renderMarket([]);
        }

        // æ¸²æŸ“æ ‡ç­¾ï¼ˆæ˜¾ç¤ºæ¨¡å¼ï¼‰
        function renderTags(tags) {
            const displayContainer = document.getElementById('tagsDisplay');
            displayContainer.innerHTML = '';
            
            tags.forEach((tag, index) => {
                const span = document.createElement('span');
                span.className = 'tag-display-item';
                span.innerHTML = `
                    <span>${tag}</span>
                    <span class="remove-display-tag" onclick="removeTag(${index})">Ã—</span>
                `;
                displayContainer.appendChild(span);
            });

            if (tags.length === 0) {
                displayContainer.innerHTML = '<span style="color: #999; font-size: 12px;">æš‚æ— æ ‡ç­¾</span>';
            }
        }

        // æ¸²æŸ“è´­ä¹°æºï¼ˆæ˜¾ç¤ºæ¨¡å¼ï¼‰
        function renderMarket(market) {
            const displayContainer = document.getElementById('marketDisplay');
            displayContainer.innerHTML = '';
            
            market.forEach((source, index) => {
                const span = document.createElement('span');
                span.className = 'tag-display-item';
                span.innerHTML = `
                    <span>${source}</span>
                    <span class="remove-display-tag" onclick="removeMarket(${index})">Ã—</span>
                `;
                displayContainer.appendChild(span);
            });

            if (market.length === 0) {
                displayContainer.innerHTML = '<span style="color: #999; font-size: 12px;">æš‚æ— è´­ä¹°æº</span>';
            }
        }

        // æ·»åŠ æ ‡ç­¾
        function addTag() {
            const input = document.getElementById('newTag');
            const tag = input.value.trim();
            if (tag) {
                getCurrentTags().push(tag);
                renderTags(getCurrentTags());
                input.value = '';
            }
        }

        // æ·»åŠ è´­ä¹°æº
        function addMarket() {
            const input = document.getElementById('newMarket');
            const source = input.value.trim();
            if (source) {
                getCurrentMarket().push(source);
                renderMarket(getCurrentMarket());
                input.value = '';
            }
        }

        // æ›´æ–°æ ‡ç­¾
        function updateTag(index, value) {
            getCurrentTags()[index] = value;
        }

        // æ›´æ–°è´­ä¹°æº
        function updateMarket(index, value) {
            getCurrentMarket()[index] = value;
        }

        // ç§»é™¤æ ‡ç­¾
        function removeTag(index) {
            getCurrentTags().splice(index, 1);
            renderTags(getCurrentTags());
        }

        // ç§»é™¤è´­ä¹°æº
        function removeMarket(index) {
            getCurrentMarket().splice(index, 1);
            renderMarket(getCurrentMarket());
        }

        // è·å–å½“å‰æ ‡ç­¾
        function getCurrentTags() {
            if (editingIndex >= 0 && items[editingIndex]) {
                if (!items[editingIndex].tags) items[editingIndex].tags = [];
                return items[editingIndex].tags;
            }
            return [];
        }

        // è·å–å½“å‰è´­ä¹°æº
        function getCurrentMarket() {
            if (editingIndex >= 0 && items[editingIndex]) {
                if (!items[editingIndex].market) items[editingIndex].market = [];
                return items[editingIndex].market;
            }
            return [];
        }

        // ä¿å­˜ç‰©å“
        function saveItem() {
            const id = document.getElementById('itemId').value;
            const nameCN = document.getElementById('nameCN').value;
            const nameEN = document.getElementById('nameEN').value;
            
            if (!id || !nameCN || !nameEN) {
                alert('è¯·å¡«å†™å¿…è¦çš„å­—æ®µï¼ˆIDã€ä¸­æ–‡åã€è‹±æ–‡åï¼‰');
                return;
            }

            const item = {
                id: parseInt(id) || id,
                nameCN: nameCN,
                nameEN: nameEN,
                quality: parseInt(document.getElementById('quality').value),
                tags: getCurrentTags(),
                market: getCurrentMarket(),
                price: parseFloat(document.getElementById('price').value) || undefined,
                weight: parseFloat(document.getElementById('weight').value) || undefined,
                image: document.getElementById('image').value || undefined,
                description: document.getElementById('description').value || undefined
            };

            if (editingIndex >= 0) {
                items[editingIndex] = item;
            } else {
                items.push(item);
            }

            saveItems();
            clearForm();
            editingIndex = -1;
            alert('ä¿å­˜æˆåŠŸï¼');
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            clearForm();
            editingIndex = -1;
            renderItems();
        }

        // å¯¼å‡º JSON
        function exportJSON() {
            if (items.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }

            const fileName = prompt('è¯·è¾“å…¥æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰:', 'items');
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹å‡»äº†å–æ¶ˆï¼ˆè¿”å› nullï¼‰
            if (fileName === null) {
                return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸æ‰§è¡Œä¸‹è½½
            }
            
            // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤åç§°
            const finalFileName = fileName.trim() === '' ? 'items.json' : fileName.trim() + '.json';

            const json = JSON.stringify(items, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = finalFileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥ JSON
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            if (confirm(`å°†å¯¼å…¥ ${data.length} ä¸ªç‰©å“ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                                items = data;
                                saveItems();
                                alert('å¯¼å…¥æˆåŠŸï¼');
                            }
                        } else {
                            alert('JSON æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯æ•°ç»„');
                        }
                    } catch (err) {
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // å¯¼å…¥ TXT
        function importTXT() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        let successCount = 0;
                        let errorCount = 0;
                        const errors = [];

                        const itemsToAdd = [];
                        const itemsToUpdate = [];
                        const duplicateIds = [];
                        
                        lines.forEach((line, index) => {
                            const trimmedLine = line.trim();
                            if (!trimmedLine) return; // è·³è¿‡ç©ºè¡Œ
                            
                            // è·³è¿‡å¯èƒ½çš„æ ‡é¢˜è¡Œï¼ˆåŒ…å«å†’å·çš„ï¼Œå¦‚ id:312153100ï¼‰
                            if (trimmedLine.includes(':') && trimmedLine.split(/\s+/).length < 3) {
                                return; // è·³è¿‡æ ‡é¢˜è¡Œ
                            }

                            // ä½¿ç”¨ç©ºæ ¼åˆ†éš”ï¼Œä½†è¦æ³¨æ„ä¸­æ–‡åå¯èƒ½åŒ…å«ç©ºæ ¼
                            // æ ¼å¼ï¼šid è‹±æ–‡å ä¸­æ–‡å
                            // è‹±æ–‡åé€šå¸¸ä¸åŒ…å«ç©ºæ ¼ï¼Œä¸­æ–‡åå¯èƒ½åŒ…å«ç©ºæ ¼
                            const parts = trimmedLine.split(/\s+/);
                            
                            if (parts.length >= 3) {
                                const id = parts[0];
                                const nameEN = parts[1];
                                // ä¸­æ–‡åæ˜¯å‰©ä½™çš„æ‰€æœ‰éƒ¨åˆ†
                                const nameCN = parts.slice(2).join(' ');
                                
                                // æ£€æŸ¥IDæ˜¯å¦å·²å­˜åœ¨
                                const existingIndex = items.findIndex(item => String(item.id) === String(id));
                                
                                const item = {
                                    id: parseInt(id) || id,
                                    nameCN: nameCN,
                                    nameEN: nameEN,
                                    quality: 1, // é»˜è®¤å“è´¨
                                    tags: [],
                                    market: []
                                };

                                if (existingIndex >= 0) {
                                    // æ”¶é›†éœ€è¦æ›´æ–°çš„ç‰©å“
                                    duplicateIds.push(id);
                                    itemsToUpdate.push({ index: existingIndex, item: item });
                                } else {
                                    itemsToAdd.push(item);
                                }
                            } else {
                                errorCount++;
                                errors.push(`ç¬¬ ${index + 1} è¡Œæ ¼å¼é”™è¯¯: ${trimmedLine}`);
                            }
                        });
                        
                        // æ·»åŠ æ–°ç‰©å“
                        items.push(...itemsToAdd);
                        successCount += itemsToAdd.length;
                        
                        // å¤„ç†é‡å¤ID
                        if (itemsToUpdate.length > 0) {
                            const shouldReplace = confirm(
                                `å‘ç° ${itemsToUpdate.length} ä¸ªå·²å­˜åœ¨çš„ç‰©å“IDï¼ˆ${duplicateIds.join(', ')}ï¼‰ã€‚\næ˜¯å¦è¦è¦†ç›–è¿™äº›ç°æœ‰ç‰©å“ï¼Ÿ`
                            );
                            
                            if (shouldReplace) {
                                itemsToUpdate.forEach(({ index, item }) => {
                                    items[index] = item;
                                });
                                successCount += itemsToUpdate.length;
                            }
                        }

                        if (successCount > 0) {
                            saveItems();
                            let message = `æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªç‰©å“ï¼`;
                            if (errorCount > 0) {
                                message += `\næœ‰ ${errorCount} è¡Œæ ¼å¼é”™è¯¯ã€‚`;
                                if (errors.length > 0) {
                                    message += '\né”™è¯¯è¯¦æƒ…ï¼š\n' + errors.slice(0, 10).join('\n');
                                    if (errors.length > 10) {
                                        message += `\n...è¿˜æœ‰ ${errors.length - 10} ä¸ªé”™è¯¯`;
                                    }
                                }
                            }
                            alert(message);
                        } else {
                            alert('æ²¡æœ‰æˆåŠŸå¯¼å…¥ä»»ä½•ç‰©å“ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚\næ ¼å¼åº”ä¸ºï¼šid è‹±æ–‡å ä¸­æ–‡åï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼‰');
                        }
                    } catch (err) {
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            };
            input.click();
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç‰©å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                items = [];
                saveItems();
            }
        }

        // åˆå§‹åŒ–
        loadItems();
    </script>
</body>
</html>

